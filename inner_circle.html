<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>True Circle - Inner Circle</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="css/styles.css" />
</head>

<body class="bg-light">
  <!-- Firebase & Feed Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIJs2JgPihGJHijJ7gO7SecxoKb2LCgrg",
      authDomain: "true-circle-gui2.firebaseapp.com",
      projectId: "true-circle-gui2",
      databaseURL: "https://true-circle-gui2-default-rtdb.firebaseio.com",
      storageBucket: "true-circle-gui2.firebasestorage.app",
      messagingSenderId: "198661237874",
      appId: "1:198661237874:web:a1ef7e3556f3a08e6da6eb",
      measurementId: "G-LHNKWW2X12"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const feed = document.getElementById("feed");

    onValue(ref(db, "posts"), snapshot => {
      const posts = [];
      snapshot.forEach(child => {
        const post = child.val();
        post.key = child.key;
        posts.push(post);
      });

      posts.sort((a, b) => (b.score || 0) - (a.score || 0));
      feed.innerHTML = "";

      posts.forEach(post => {
        const scorePercent = (post.score * 100).toFixed(1);
        const scoreClass = post.score >= 0.75 ? "score-high"
                         : post.score >= 0.5 ? "score-medium"
                         : "score-low";

        const div = document.createElement("div");
        div.className = "card mb-3 p-3 shadow-sm";

        div.innerHTML = `
          <p class="mb-2">${post.content}</p>
          <div class="d-flex align-items-center mb-1">
            <button class="btn btn-sm btn-outline-success me-2 upvote">üëç</button>
            <button class="btn btn-sm btn-outline-danger me-2 downvote">üëé</button>
            <small class="${scoreClass}">Score: ${scorePercent}%</small>
          </div>
        `;

        div.querySelector(".upvote").addEventListener("click", () => vote(post.key, "up"));
        div.querySelector(".downvote").addEventListener("click", () => vote(post.key, "down"));
        feed.appendChild(div);
      });
    });

    function vote(postId, type) {
      const postRef = ref(db, `posts/${postId}`);
      onValue(postRef, snapshot => {
        const post = snapshot.val();
        if (!post) return;

        let up = post.upvotes || 0;
        let down = post.downvotes || 0;

        if (type === "up") up++;
        if (type === "down") down++;

        const total = up + down;
        const newScore = total ? up / total : 0;

        update(postRef, {
          upvotes: up,
          downvotes: down,
          score: newScore
        });
      }, { onlyOnce: true });
    }
  </script>

  <!-- Header -->
  <header class="container-fluid py-3 shadow-sm fixed-top">
    <!-- Logo -->
    <div class="row align-items-center px-4">
      <div class="col-md-3 text-md-start text-center">
        <a href="index.html" class="text-decoration-none text-dark">
          <h2 class="fw-bold mb-0">True Circle</h2>
        </a>
      </div>

      <!-- Navigation Bar -->
      <div class="col-md-9 text-md-end text-center mt-2 mt-md-0">
        <nav>
          <a href="inner_circle.html" class="mx-2 text-decoration-none">Inner Circle</a>
          <a href="#" class="mx-2 text-decoration-none">Outer Circle</a>
          <a href="new_post.html" class="mx-2 text-decoration-none">New Post</a>
        </nav>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container pt-5">
    <section class="mx-auto" style="max-width: 700px;">
      <h2 class="mb-4 text-center">Inner Circle Feed</h2>
  
      <!-- Temporary Post Card 1 -->
      <div class="card p-3 mb-4 shadow-sm">
        <div class="d-flex justify-content-between">
          <strong>@Koda-B</strong>
          <small class="text-muted">2h ago</small>
        </div>
        <p class="mt-2 mb-1">Took a surprise swim today! Water was cool, and I might have swallowed a leaf.<br><br>#FloofLife #GettingDry. üå≤‚ú®</p>
        <img src="img/koda-splash.jpg" alt="koda splash" class="img-fluid rounded mb-2">
  
        <!-- Feedback Row -->
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-success btn-sm">üëç</button>
            <button type="button" class="btn btn-outline-danger btn-sm">üëé</button>
          </div>
          <div class="text-muted" style="font-size: 0.9em;">
            Vote Balance: <strong>99% positive</strong>
          </div>
        </div>
      </div>
  
      <!-- Temporary Post Card 2 -->
      <div class="card p-3 mb-4 shadow-sm">
        <div class="d-flex justify-content-between">
          <strong>@Lilly-P-Hopper</strong>
          <small class="text-muted">2h ago</small>
        </div>
        <p class="mt-2 mb-1">Just watched a polarbear cloud cannonball into my living room.<br><br>#DogInvasion #StillInMyPond</p>
        <img src="img/frog2.jpg" alt="frog" class="img-fluid rounded mb-2">
  
        <!-- Feedback Row -->
        <div class="d-flex justify-content-between align-items-center mt-3">
          <div class="btn-group" role="group">
			<button class="btn btn-link p-0" onclick="openComments()">üí¨ View Comments</button>
            <button type="button" class="btn btn-outline-success btn-sm">üëç</button>
            <button type="button" class="btn btn-outline-danger btn-sm">üëé</button>
          </div>
          <div class="text-muted" style="font-size: 0.9em;">
            Vote Balance: <strong>87% positive</strong>
          </div>
        </div>
      </div>
		
      <div id="commentOverlay" class="overlay d-none">
        <div class="overlay-content card p-4 shadow">
          <h5 class="mb-3">Comments</h5>
          <div class="comment mb-3">
            <strong>@frogfriend</strong><br>
            I love this‚Äîit resonates deeply.
          </div>
          <textarea class="form-control mb-3" placeholder="Add your comment..."></textarea>
          <button class="btn btn-primary">Submit</button>
          <button class="btn btn-secondary" onclick="closeComments()">Close</button>
        </div>
      </div>
  
    </section>
  </main>

  <!-- Feed -->
  <div class="container mt-4">
    <h3 class="mb-4">Your Inner Circle</h3>
    <div id="feed"></div>
  </div>

  <!-- Footer -->
  <footer class="text-center px-3 mt-5 pt-3">
    <small class="text-muted">Built for Truth. Wired for Connection.</small>
  </footer>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Dynamic Header Spacing -->
  <script>
    const header = document.querySelector('header');
    document.body.style.paddingTop = `${header.offsetHeight + 25}px`;
  </script>
	
  <script>
	function openComments() {
      document.getElementById('commentOverlay').classList.remove('d-none');
    }
    function closeComments() {
      document.getElementById('commentOverlay').classList.add('d-none');
    }
  </script>

</body>
</html>