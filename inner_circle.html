<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>True Circle - Inner Circle</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="css/styles.css" />
</head>

<body class="bg-light">
  <!-- Firebase & Feed Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, onValue, update } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
    import { remove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAIJs2JgPihGJHijJ7gO7SecxoKb2LCgrg",
      authDomain: "true-circle-gui2.firebaseapp.com",
      projectId: "true-circle-gui2",
      databaseURL: "https://true-circle-gui2-default-rtdb.firebaseio.com",
      storageBucket: "true-circle-gui2.firebasestorage.app",
      messagingSenderId: "198661237874",
      appId: "1:198661237874:web:a1ef7e3556f3a08e6da6eb",
      measurementId: "G-LHNKWW2X12"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const feed = document.getElementById("feed");

    onValue(ref(db, "posts"), snapshot => {
      const posts = [];
      snapshot.forEach(child => {
        const post = child.val();
        post.key = child.key;
        posts.push(post);
      });

      posts.sort((a, b) => (b.score || 0) - (a.score || 0));
      feed.innerHTML = "";

      posts.forEach(post => {
        const scorePercent = (post.score * 100).toFixed(1);
        const scoreClass = post.score >= 0.75 ? "score-high"
                         : post.score >= 0.5 ? "score-medium"
                         : "score-low";
        const now = Date.now();
        const postTime = post.timestamp || now;
        const ageMillis = now - postTime;

        function formatAge(ms) {
          const secs = Math.floor(ms / 1000);
          const mins = Math.floor(secs / 60);
          const hours = Math.floor(mins / 60);
          const days = Math.floor(hours / 24);

          if (days > 0) return `${days} day${days > 1 ? "s" : ""} ago`;
          if (hours > 0) return `${hours} hour${hours > 1 ? "s" : ""} ago`;
          if (mins > 0) return `${mins} min${mins > 1 ? "s" : ""} ago`;
          return `Just now`;
        }

        const postAge = formatAge(ageMillis);

        const div = document.createElement("div");
        div.className = "card mb-3 p-3 shadow-sm";

        div.innerHTML = `
          <p class="mb-2">${post.content}</p>
          ${post.imageURL ? `<img class="post-image mb-2" src="${post.imageURL}" alt="Uploaded image">` : ""}
          <div class="d-flex align-items-center justify-content-between mb-1">
            <div>
              <button class="btn btn-sm btn-outline-success me-2 upvote">üëç</button>
              <button class="btn btn-sm btn-outline-danger me-2 downvote">üëé</button>
              <button class="btn btn-sm btn-outline-secondary me-2 delete">üóëÔ∏è</button>
              <small class="${scoreClass}">Score: ${scorePercent}%</small>
            </div>
            <small class="text-muted">üïì ${postAge}</small>
          </div>
        `;

        div.querySelector(".upvote").addEventListener("click", () => vote(post.key, "up"));
        div.querySelector(".downvote").addEventListener("click", () => vote(post.key, "down"));
        div.querySelector(".delete").addEventListener("click", () => {
          const confirmDelete = confirm("Delete this post?");
          if (confirmDelete) {
            const postRef = ref(db, `posts/${post.key}`);
            remove(postRef);
          }
        });

        feed.appendChild(div);
      });
    });

    function vote(postId, type) {
      const postRef = ref(db, `posts/${postId}`);
      onValue(postRef, snapshot => {
        const post = snapshot.val();
        if (!post) return;

        let up = post.upvotes || 0;
        let down = post.downvotes || 0;

        if (type === "up") up++;
        if (type === "down") down++;

        const total = up + down;
        const newScore = total ? up / total : 0;

        update(postRef, {
          upvotes: up,
          downvotes: down,
          score: newScore
        });
      }, { onlyOnce: true });
    }
  </script>

  <!-- Header -->
  <header class="container-fluid py-3 shadow-sm fixed-top">
    <!-- Logo -->
    <div class="row align-items-center px-4">
      <div class="col-md-3 text-md-start text-center">
        <a href="index.html" class="text-decoration-none text-dark">
          <h2 class="fw-bold mb-0">True Circle</h2>
        </a>
      </div>

      <!-- Navigation Bar -->
      <div class="col-md-9 text-md-end text-center mt-2 mt-md-0">
        <nav>
          <a href="inner_circle.html" class="mx-2 text-decoration-none">Inner Circle</a>
          <a href="#" class="mx-2 text-decoration-none">Outer Circle</a>
          <a href="new_post.html" class="mx-2 text-decoration-none">New Post</a>
        </nav>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="container pt-5">
    <section class="mx-auto" style="max-width: 700px;">
      <h2 class="mb-4 text-center">Your Inner Circle</h2>
  
      <!-- Feed -->
      <div class="container mt-4">
        <div id="feed"></div>
      </div>
    </section>
    
  </main>


  <!-- Footer -->
  <footer class="text-center px-3 mt-5 pt-3">
    <small class="text-muted">Built for Truth. Wired for Connection.</small>
  </footer>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Dynamic Header Spacing -->
  <script>
    const header = document.querySelector('header');
    document.body.style.paddingTop = `${header.offsetHeight + 25}px`;
  </script>
	
  <script>
	function openComments() {
      document.getElementById('commentOverlay').classList.remove('d-none');
    }
    function closeComments() {
      document.getElementById('commentOverlay').classList.add('d-none');
    }
  </script>

</body>
</html>